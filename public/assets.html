<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Tourism Assets - NWP Portal</title>
<link rel="stylesheet" href="/css/style.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
</head>
<body>
<header>
  <div class="logo">NWP Tourism</div>
  <nav>
    <ul>
      <li><a href="/">Home</a></li>
      <li><a href="/assets.html" class="active">Tourism Assets</a></li>
      <li><a href="/analysis.html">Gap Analysis</a></li>
      <li><a href="/recommendations.html">Recommendations</a></li>
      <li><a href="/about.html">About</a></li>
    </ul>
  </nav>
</header>
<main>
  <h1>Tourism Assets Map</h1>
  <div id="map" style="height: 600px; border-radius: 8px; border: 2px solid #2c5c3b;"></div>
</main>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const map = L.map('map').setView([7.5, 80.3], 8);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 18,
  attribution: 'Â© OpenStreetMap contributors'
}).addTo(map);

let boundaryLayer = null;
let pointsLayer = null;

async function loadLastGeoJSON() {
  try {
    const res = await fetch('/api/last-uploaded-geojson');
    const data = await res.json();
    if (data.filename) {
      loadGeoJSON(data.filename);
    }
  } catch (err) {
    console.error('Failed to load last uploaded GeoJSON:', err);
  }
}

async function loadGeoJSON(filename) {
  try {
    const res = await fetch(`/geojson/${filename}`);
    if (!res.ok) throw new Error('Failed to fetch GeoJSON');

    const geojson = await res.json();

    if (boundaryLayer) map.removeLayer(boundaryLayer);
    if (pointsLayer) map.removeLayer(pointsLayer);

    const polygons = {
      type: 'FeatureCollection',
      features: geojson.features.filter(f => ['Polygon', 'MultiPolygon'].includes(f.geometry.type))
    };
    const points = {
      type: 'FeatureCollection',
      features: geojson.features.filter(f => f.geometry.type === 'Point')
    };

    if (polygons.features.length > 0) {
      boundaryLayer = L.geoJSON(polygons, {
        style: { color: '#2c5c3b', weight: 3, fillOpacity: 0.1 }
      }).addTo(map);
      map.fitBounds(boundaryLayer.getBounds());
    }

    if (points.features.length > 0) {
      pointsLayer = L.geoJSON(points, {
        pointToLayer: (feature, latlng) => L.circleMarker(latlng, {
          radius: 6,
          fillColor: '#2c5c3b',
          color: '#155724',
          weight: 1,
          opacity: 1,
          fillOpacity: 0.8
        }),
        onEachFeature: (feature, layer) => {
          if (feature.properties) {
            const popupContent = Object.entries(feature.properties)
              .map(([k, v]) => `<strong>${k}:</strong> ${v}`)
              .join('<br>');
            layer.bindPopup(popupContent);
          }
        }
      }).addTo(map);
    }
  } catch (err) {
    console.error(err);
  }
}

async function loadAssets() {
  try {
    const res = await fetch('/api/assets');
    const assets = await res.json();

    if (pointsLayer) {
      map.removeLayer(pointsLayer);
      pointsLayer = null;
    }
    if (!assets.length) return;

    pointsLayer = L.layerGroup();

    assets.forEach(asset => {
      const marker = L.circleMarker([asset.latitude, asset.longitude], {
        radius: 6,
        fillColor: '#ff7800',
        color: '#b35200',
        weight: 1,
        opacity: 1,
        fillOpacity: 0.9
      });
      let popupHtml = `<strong>${asset.name}</strong><br>
        Category: ${asset.category}<br>
        ${asset.description}<br>`;
      if (asset.image_url) {
        popupHtml += `<img src="${asset.image_url}" alt="${asset.name}" style="width:100px; margin-top:5px;">`;
      }
      marker.bindPopup(popupHtml);
      pointsLayer.addLayer(marker);
    });

    pointsLayer.addTo(map);
  } catch (err) {
    console.error(err);
  }
}

window.onload = async () => {
  await loadLastGeoJSON();
  await loadAssets();
};
</script>
</body>
</html>

